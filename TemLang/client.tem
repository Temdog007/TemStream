enum ClientCommand {
    ShowStatus
    ConnectToStream
    DisconnectFromStream
    StartStreaming
    UploadText
    UploadFile
    SaveScreenshot
    ToggleDisplay
    ChangeAudioVolume
    ChangeAudioSource
    ChangePressToTalk
    ChangeSilenceThreshold
    Quit
}

enum CustomEvent {
    UpdateStreamDisplay
    ShowSimpleMessage
    SendLobbyMessage
    SaveScreenshot
    UpdateAudioDisplay
    UpdateVideoDisplay
    RecordingAudio
}

struct VideoFrame {
    [0 u8] video
    Guid id
    u16 width
    u16 height
}

struct Client {
    string name
    [ 0 u8 ] payload
    Guid id
    i64 joinTime
    u64 lastMessage
}

struct ClientQuery {
    Client client
    bool readAccess
    bool writeAccess
}

variant UserInputData {
    null startStream
    ClientQuery queryAudio
    ClientQuery queryVideo
    string file
    string text
}

struct UserInput {
    Guid id
    UserInputData data
}

inlineC "MAKE_DEFAULT_LIST(UserInput);"

variant TalkMode {
    string pressToTalk
    string pressToMute
    null none
}

struct ClientConfiguration {
    string ttfFile
    string hostname
    Authentication authentication
    TalkMode talkMode
    f32 silenceThreshold
    i32 fontSize
    i32 windowWidth
    i32 windowHeight
    u16 port
    bool noGui
    bool noAudio
    bool showLabel
    bool fullscreen
}

struct Rect {
    i32 x
    i32 y
    i32 w
    i32 h
}

variant OptionalRect {
    null none
    Rect rect
}

struct FRect {
    f32 x
    f32 y
    f32 w
    f32 h
}

enum MoveMode {
    None
    Position
    Size
}

struct StreamDisplayChat {
    [0 Chat] logs
    u32 offset
    u32 count
}

variant StreamDisplayData {
    null none
    [ 0 u8 ] image
    StreamDisplayChat chat
    string text
    [2 i32] videoDimensions
    [2 i64] timeRange
}

struct CurrentAudio {
    Guid id
    [ 0 u8 ] audio
}

resource StreamDisplay {
    ServerConfiguration config
    StreamDisplayData data
    Client client
    [ 0 null ] outgoing
    FRect dstRect
    OptionalRect srcRect
    Guid id
    u32 recordings
    u32 mtu
    bool choosingPlayback
    bool visible
    null texture
} r {
    inlineC "
        SDL_DestroyTexture(r.texture);
        for(size_t i = 0; i < r.outgoing.used; ++i){
            enet_packet_destroy(r.outgoing.buffer[i]);
        }
    "
}

inlineC "
    MAKE_DEFAULT_LIST(StreamDisplay);
    extern void unloadSink(int32_t);
"

resource ClientData {
    [0 ServerConfiguration] allStreams
    [0 StreamDisplay] displays
    null configuration
    null mutex
} c {
    inlineC "
        SDL_DestroyMutex(c.mutex);
    "
}

enum AudioStreamSource {
    None
    Microphone
    Window
    File
}

enum VideoStreamSource {
    None
    Webcam
    Window
}

enum ImageExtension {
    ICO
    CUR
    BMP
    JPG
    JPEG 
    LBM
    PCX
    PNG
    PNM 
    SVG
    TGA
    WEBP
    XCF 
    XPM 
    XV 
}

enum AudioExtension {
    WAV
    MP3
    OGG
}

variant FileExtension {
    AudioExtension audio
    ImageExtension image
    null font
    null text
}

struct AudioSendThreadData {
    [ 0 null ] packets
    Guid id
}

struct SinkInput {
    string name
    i32 inputId
    i32 currentSinkId
    i32 processId
}

struct Ratio {
    u32 numerator
    u32 denominator
}

struct WindowData {
    string name
    Guid id
    null connection
    Ratio ratio
    u32 windowId
    u32 bitrateInMbps
    u16 width
    u16 height
    u16 fps
    u16 keyFrameInterval
}

inlineC "MAKE_DEFAULT_LIST(WindowData);"

inlineText imageConversionsKernel "kernel/image_conversions.cl"

flag MouseState {
    InWindow
    Visible
}